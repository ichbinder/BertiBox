<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BertiBox - Playlist Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .playlist-item {
            cursor: move;
        }
        .current-tag {
            background-color: #e9ecef;
        }
        .title-truncate {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>BertiBox - Playlist Manager</h1>
        
        <!-- Aktueller Tag -->
        <div class="card mb-4">
            <div class="card-header">
                Aktueller Tag
            </div>
            <div class="card-body">
                <p id="current-tag" class="mb-0">Kein Tag erkannt</p>
            </div>
        </div>
        
        <!-- Tags und Playlists -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Tags</span>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTagModal">
                            <i class="bi bi-plus"></i> Neuer Tag
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="list-group" id="tag-list">
                            <!-- Tags werden hier dynamisch eingefügt -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Playlist
                    </div>
                    <div class="card-body">
                        <div id="playlist-items" class="list-group">
                            <!-- Playlist-Items werden hier dynamisch eingefügt -->
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary btn-sm" id="add-to-playlist" disabled>
                                <i class="bi bi-plus"></i> MP3 zur Playlist hinzufügen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal für neuen Tag -->
    <div class="modal fade" id="addTagModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Neuen Tag hinzufügen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTagForm">
                        <div class="mb-3">
                            <label for="tagId" class="form-label">Tag ID</label>
                            <input type="text" class="form-control" id="tagId" required>
                        </div>
                        <div class="mb-3">
                            <label for="tagName" class="form-label">Name (optional)</label>
                            <input type="text" class="form-control" id="tagName">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" id="saveTag">Speichern</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal für MP3 zur Playlist hinzufügen -->
    <div class="modal fade" id="addToPlaylistModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">MP3s zur Playlist hinzufügen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addToPlaylistForm">
                        <div class="mb-3">
                            <label for="mp3Files" class="form-label">MP3 Dateien</label>
                            <select class="form-select" id="mp3Files" multiple size="10">
                                {% for mp3 in mp3_files %}
                                <option value="{{ mp3 }}">{{ mp3 }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                Halten Sie Strg gedrückt, um mehrere Dateien auszuwählen
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" id="saveToPlaylist">Hinzufügen</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <script>
        const socket = io();
        let currentTag = null;
        let currentPlaylist = null;
        let addTagModal = null;
        let addToPlaylistModal = null;
        
        // Modal-Instanzen initialisieren
        document.addEventListener('DOMContentLoaded', function() {
            addTagModal = new bootstrap.Modal(document.getElementById('addTagModal'));
            addToPlaylistModal = new bootstrap.Modal(document.getElementById('addToPlaylistModal'));
        });
        
        // Socket.IO Events
        socket.on('tag_detected', function(data) {
            currentTag = data.tag_id;
            document.getElementById('current-tag').textContent = `Tag ID: ${currentTag}`;
            loadTags();
        });
        
        socket.on('playlist_selected', function(data) {
            currentPlaylist = data.id;
            document.getElementById('add-to-playlist').disabled = false;
            displayPlaylistItems(data.items);
        });
        
        // Tags laden
        function loadTags() {
            fetch('/api/tags')
                .then(response => response.json())
                .then(tags => {
                    const tagList = document.getElementById('tag-list');
                    tagList.innerHTML = '';
                    
                    tags.forEach(tag => {
                        const tagElement = document.createElement('div');
                        tagElement.className = `list-group-item list-group-item-action ${tag.tag_id === currentTag ? 'current-tag' : ''}`;
                        tagElement.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div onclick="selectTag('${tag.tag_id}')" style="cursor: pointer; flex-grow: 1;">
                                    <strong>${tag.name || tag.tag_id}</strong>
                                    ${tag.playlist ? `<br><small>${tag.playlist}</small>` : ''}
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="editTag('${tag.tag_id}', '${tag.name || ''}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTag('${tag.tag_id}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        tagList.appendChild(tagElement);
                    });
                });
        }
        
        // Tag auswählen
        function selectTag(tagId) {
            currentTag = tagId;
            document.getElementById('current-tag').textContent = `Tag ID: ${currentTag}`;
            
            // Playlist für den Tag laden
            fetch(`/api/tags/${tagId}/playlist`)
                .then(response => response.json())
                .then(data => {
                    if (data.items) {
                        currentPlaylist = data.id;
                        document.getElementById('add-to-playlist').disabled = false;
                        displayPlaylistItems(data.items);
                    } else {
                        // Neue Playlist erstellen
                        fetch('/api/playlists', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                tag_id: tagId,
                                name: `Playlist für ${tagId}`
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            currentPlaylist = data.id;
                            document.getElementById('add-to-playlist').disabled = false;
                            displayPlaylistItems([]);
                        });
                    }
                });
            
            // Tags neu laden, um den ausgewählten Tag zu markieren
            loadTags();
        }
        
        // Playlist-Items anzeigen
        function displayPlaylistItems(items) {
            const playlistContainer = document.getElementById('playlist-items');
            playlistContainer.innerHTML = '';
            
            items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'list-group-item playlist-item';
                itemElement.setAttribute('data-id', item.id);
                itemElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="title-truncate" title="${item.mp3_file}">${item.mp3_file}</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePlaylistItem(${item.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                playlistContainer.appendChild(itemElement);
            });
            
            // Sortable für die Playlist-Items initialisieren
            new Sortable(playlistContainer, {
                animation: 150,
                onEnd: function(evt) {
                    const items = Array.from(playlistContainer.children).map((item, index) => ({
                        id: item.getAttribute('data-id'),
                        position: index
                    }));
                    
                    // Positionen aktualisieren
                    items.forEach(item => {
                        fetch(`/api/playlist-items/${item.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                position: item.position
                            })
                        });
                    });
                }
            });
        }
        
        // Tag bearbeiten
        function editTag(tagId, currentName) {
            document.getElementById('tagId').value = tagId;
            document.getElementById('tagName').value = currentName;
            addTagModal.show();
        }
        
        // Tag hinzufügen/bearbeiten
        document.getElementById('saveTag').addEventListener('click', function() {
            const tagId = document.getElementById('tagId').value;
            const tagName = document.getElementById('tagName').value;
            
            fetch('/api/tags', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tag_id: tagId,
                    name: tagName
                })
            })
            .then(response => response.json())
            .then(data => {
                loadTags();
                addTagModal.hide();
                document.getElementById('tagId').value = '';
                document.getElementById('tagName').value = '';
            });
        });
        
        // Tag löschen
        function deleteTag(tagId) {
            if (confirm('Möchten Sie diesen Tag wirklich löschen?')) {
                fetch(`/api/tags/${tagId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        loadTags();
                    }
                });
            }
        }
        
        // Playlist-Item hinzufügen
        document.getElementById('add-to-playlist').addEventListener('click', function() {
            if (!currentTag) {
                alert('Bitte wählen Sie zuerst einen Tag aus');
                return;
            }
            
            addToPlaylistModal.show();
        });
        
        // Event-Listener für den Speichern-Button im MP3-Modal
        document.getElementById('saveToPlaylist').addEventListener('click', function() {
            if (!currentPlaylist) {
                alert('Bitte wählen Sie zuerst einen Tag aus');
                return;
            }
            
            addMp3sToPlaylist(currentPlaylist);
            addToPlaylistModal.hide();
        });
        
        function addMp3sToPlaylist(playlistId) {
            const selectedFiles = Array.from(document.getElementById('mp3Files').selectedOptions).map(option => option.value);
            if (selectedFiles.length === 0) {
                alert('Bitte wählen Sie mindestens eine MP3-Datei aus');
                return;
            }

            fetch(`/api/playlists/${playlistId}/items/batch`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    mp3_files: selectedFiles
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Fehler beim Hinzufügen der MP3s: ' + data.error);
                    return;
                }
                // Hole die aktualisierten Playlist-Items
                fetch(`/api/tags/${currentTag}/playlist`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.items) {
                            displayPlaylistItems(data.items);
                        }
                    });
                document.getElementById('mp3Files').selectedIndex = -1;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Fehler beim Hinzufügen der MP3s');
            });
        }
        
        // Playlist-Item löschen
        function deletePlaylistItem(itemId) {
            if (confirm('Möchten Sie dieses Item wirklich aus der Playlist entfernen?')) {
                fetch(`/api/playlist-items/${itemId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        // Hole die aktualisierten Playlist-Items
                        fetch(`/api/tags/${currentTag}/playlist`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.items) {
                                    displayPlaylistItems(data.items);
                                }
                            });
                    }
                });
            }
        }
        
        // Initial laden
        loadTags();
    </script>
</body>
</html> 